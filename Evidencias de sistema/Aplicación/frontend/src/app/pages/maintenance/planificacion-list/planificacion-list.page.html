<ion-content [fullscreen]="true" class="ion-padding">
  <ion-refresher slot="fixed" (ionRefresh)="cargarPlanificaciones($event)">
    <ion-refresher-content
      pullingIcon="chevron-down-circle-outline"
      refreshingSpinner="crescent"
      refreshingText="Actualizando..."
    >
    </ion-refresher-content>
  </ion-refresher>
  <ion-loading [isOpen]="isLoading" message="Cargando..."></ion-loading>
<ion-row>
    <ion-col size="12">
      <ion-card class="welcome-card glass-effect"> <!-- Usamos ion-card para el mismo estilo que el dashboard -->
        <ion-card-content class="ion-text-center">
          <ion-text color="primary">
            <h1 class="ion-no-margin welcome-title">Gestión de Planes de Mantenimiento</h1>
          </ion-text>
          <p class="ion-text-wrap dashboard-intro-text">
            Administra de manera eficiente los planes de mantenimiento preventivo y correctivo de tu flota. Aquí puedes crear, editar, visualizar y generar órdenes de trabajo para cada plan.
          </p>
        </ion-card-content>
      </ion-card>
    </ion-col>
  </ion-row>
  <!-- Filtros -->
  <ion-card class="filters-card" *ngIf="!isLoading">
    <ion-card-header>
      <ion-card-title>
        <ion-icon name="funnel-outline"></ion-icon>
        Filtros
      </ion-card-title>
    </ion-card-header>
    <ion-card-content>
      <ion-grid>
        <ion-row>
          <ion-col size="12" size-md="4">
            <ion-item>
              <ion-input
                [(ngModel)]="searchTerm"
                placeholder="Buscar por descripción o tareas..."
                (ionInput)="applyFilters()"
                clear-input="true"
              >
                <ion-icon name="search-outline" slot="start"></ion-icon>
              </ion-input>
            </ion-item>
          </ion-col>
          <ion-col size="12" size-md="3">
            <ion-item>
              <ion-select
                [(ngModel)]="filterTipo"
                (ionChange)="applyFilters()"
                placeholder="Filtrar por tipo"
                interface="popover"
              >
                <ion-select-option value="">Todos los tipos</ion-select-option>
                <ion-select-option value="preventivo"
                  >Preventivo</ion-select-option
                >
                <ion-select-option value="correctivo"
                  >Correctivo</ion-select-option
                >
              </ion-select>
            </ion-item>
          </ion-col>
          <ion-col size="12" size-md="3">
            <ion-item>
              <ion-select
                [(ngModel)]="filterEstado"
                (ionChange)="applyFilters()"
                placeholder="Filtrar por estado"
                interface="popover"
              >
                <ion-select-option value=""
                  >Todos los estados</ion-select-option
                >
                <ion-select-option value="activo">Activo</ion-select-option>
                <ion-select-option value="inactivo">Inactivo</ion-select-option>
              </ion-select>
            </ion-item>
          </ion-col>
          <ion-col size="12" size-md="2">
            <ion-button expand="block" fill="outline" (click)="clearFilters()">
              <ion-icon name="refresh-outline" slot="start"></ion-icon>
              Limpiar
            </ion-button>
          </ion-col>
        </ion-row>
      </ion-grid>
    </ion-card-content>
  </ion-card>
  <div
    *ngIf="!isLoading && paginatedPlanificaciones.length === 0 && allItems.length === 0"
    class="ion-text-center ion-padding"
  >
    <ion-icon
      name="file-tray-stacked-outline"
      style="font-size: 4em"
      color="medium"
    ></ion-icon>
    <p>No hay planes de mantenimiento para mostrar.</p>
    <ion-button (click)="irACrearPlan()" expand="block" fill="outline">
      <ion-icon slot="start" name="add-circle-outline"></ion-icon>
      Crear Nueva Planificación
    </ion-button>
  </div>
  <ion-list *ngIf="paginatedPlanificaciones.length > 0">
    <ion-item
      *ngFor="let plan of paginatedPlanificaciones"
      lines="inset"
      class="planificacion-item"
    >
      <ion-grid>
        <ion-row class="ion-align-items-center">
          <ion-col
            size="12"
            size-md="5"
            (click)="verDetalle(plan)"
            style="cursor: pointer"
          >
            <ion-label>
              <h2>
                <ion-icon
                  [name]="getIconForPlanStatus(plan)"
                  class="align-middle plan-icon-bold"
                ></ion-icon>
                {{ plan.descPlan | uppercase }}
              </h2>
              <p>
                <ion-icon
                  name="calendar-outline"
                  color="primary"
                  class="align-middle"
                ></ion-icon>
                <strong>Frecuencia:</strong> {{ plan.frecuencia }} {{
                plan.tipoFrecuencia }}
              </p>
              <p>
                <ion-icon
                  name="list-outline"
                  color="success"
                  class="align-middle"
                ></ion-icon>
                <strong>Tareas:</strong> {{ plan.tareas?.length || 0 }} |
                <strong>Vehículos:</strong> {{ plan.vehiculosEnPlan?.length || 0
                }}
            <p>
  <ion-icon
    name="car-outline"
    color="warning"
    class="align-middle"
  ></ion-icon>
  <strong>Vehículos:</strong>
  <ng-container *ngIf="plan.vehiculosEnPlan && plan.vehiculosEnPlan.length > 0; else sinVehiculos">
    <span *ngFor="let vehiculo of plan.vehiculosEnPlan; let i = index">
      {{ vehiculo.patente }} ({{ vehiculo.marca }} {{ vehiculo.modelo }})
      <span *ngIf="i < plan.vehiculosEnPlan.length - 1">, </span>
    </span>
  </ng-container>
  <ng-template #sinVehiculos>No asignados</ng-template>
</p>

            </ion-label>
          </ion-col>

          <ion-col size="12" size-md="2">
            <ion-label class="info-col">
              <p>
                <ion-icon name="time-outline" class="align-middle"></ion-icon>
                <strong>Creado:</strong> {{ plan.createdAt | date:'dd/MM/yy' }}
              </p>
              <p>
                <ion-icon
                  name="shield-checkmark-outline"
                  class="align-middle"
                  color="primary"
                ></ion-icon>
                <strong>Tipo:</strong> {{ plan.esPreventivo ? 'Preventivo' :
                'Correctivo' }}
              </p>
            </ion-label>
          </ion-col>

          <ion-col size="12" size-md="2" class="ion-text-center">
            <ion-chip
              [color]="plan.esActivoPlan ? (plan.esPreventivo ? 'success' : 'warning') : 'medium'"
            >
              <ion-label
                >{{ plan.esActivoPlan ? (plan.esPreventivo ? 'Preventivo' :
                'Correctivo') : 'Inactivo' }}</ion-label
              >
            </ion-chip>
          </ion-col>

          <ion-col
            size="12"
            size-md="3"
            class="ion-text-md-end ion-text-center action-buttons"
          >
         
            <ion-button
              fill="clear"
              size="small"
              (click)="verDetalle(plan)"
              title="Ver Detalles"
            >
              <ion-icon
                slot="icon-only"
                name="eye-outline"
                color="primary"
              ></ion-icon>
            </ion-button>

            <ion-button
              fill="clear"
              size="small"
              (click)="editarPlan(plan)"
              title="Editar Plan"
            >
              <ion-icon
                slot="icon-only"
                name="create-outline"
                color="tertiary"
              ></ion-icon>
            </ion-button>

            <ion-button
              fill="clear"
              size="small"
              (click)="confirmarEliminar(plan)"
              title="Eliminar Plan"
            >
              <ion-icon
                slot="icon-only"
                name="trash-outline"
                color="danger"
              ></ion-icon>
            </ion-button>
          </ion-col>
        </ion-row>
      </ion-grid>
    </ion-item>
  </ion-list>

  <!-- Paginador -->
  <div class="pagination-container" *ngIf="paginatedPlanificaciones.length > 0">
    <ion-grid>
      <ion-row class="ion-align-items-center">
        <ion-col size="12" size-md="6">
          <p class="pagination-info">
            Mostrando {{ (currentPage - 1) * pageSize + 1 }} - {{
            Math.min(currentPage * pageSize, totalFilteredItems) }} de {{
            totalFilteredItems }} planificaciones
          </p>
        </ion-col>
        <ion-col size="12" size-md="6" class="ion-text-end">
          <ion-button
            fill="clear"
            [disabled]="currentPage === 1"
            (click)="previousPage()"
          >
            <ion-icon slot="start" name="chevron-back"></ion-icon>
            Anterior
          </ion-button>
          <span class="page-indicator"
            >{{ currentPage }} / {{ totalPages }}</span
          >
          <ion-button
            fill="clear"
            [disabled]="currentPage === totalPages"
            (click)="nextPage()"
          >
            Siguiente
            <ion-icon slot="end" name="chevron-forward"></ion-icon>
          </ion-button>
        </ion-col>
      </ion-row>
    </ion-grid>
  </div>

  <!-- Botón flotante para crear plan de mantenimiento -->
  <ion-fab
    vertical="top"
    horizontal="end"
    slot="fixed"
    style="top: 80px; right: 16px"
  >
    <ion-fab-button
      (click)="irACrearPlan()"
      style="--background: #008000; --color: white"
      size="small"
    >
      <ion-icon name="add"></ion-icon>
    </ion-fab-button>
  </ion-fab>
</ion-content>
