<ion-content [fullscreen]="true">
  <ion-refresher slot="fixed" (ionRefresh)="loadItems($event)">
    <ion-refresher-content
      pullingIcon="chevron-down-circle-outline"
      refreshingSpinner="crescent"
      refreshingText="Actualizando..."
    >
    </ion-refresher-content>
  </ion-refresher>

  <!-- Segmento de pestañas por estado -->
  <ion-segment
    [(ngModel)]="selectedStatusTab"
    (ionChange)="onStatusTabChange($event)"
    class="status-tabs"
  >
    <ion-segment-button value="todas">
      <ion-label>Todas</ion-label>
      <ion-badge *ngIf="getCountByStatus('todas') > 0" color="medium">
        {{ getCountByStatus('todas') }}
      </ion-badge>
    </ion-segment-button>
    <ion-segment-button value="sin_iniciar">
      <ion-label>Sin Iniciar</ion-label>
      <ion-badge *ngIf="getCountByStatus('sin_iniciar') > 0" color="primary">
        {{ getCountByStatus('sin_iniciar') }}
      </ion-badge>
    </ion-segment-button>
    <ion-segment-button value="en_progreso">
      <ion-label>En Progreso</ion-label>
      <ion-badge *ngIf="getCountByStatus('en_progreso') > 0" color="warning">
        {{ getCountByStatus('en_progreso') }}
      </ion-badge>
    </ion-segment-button>
    <ion-segment-button value="completada">
      <ion-label>Completada</ion-label>
      <ion-badge *ngIf="getCountByStatus('completada') > 0" color="success">
        {{ getCountByStatus('completada') }}
      </ion-badge>
    </ion-segment-button>
    <ion-segment-button value="rechazado">
      <ion-label>Deshabilitada</ion-label>
      <ion-badge *ngIf="getCountByStatus('rechazado') > 0" color="danger">
        {{ getCountByStatus('rechazado') }}
      </ion-badge>
    </ion-segment-button>
  </ion-segment>

  <!-- Filtros (solo se muestran en la pestaña "Todas") -->
  <ion-card class="filters-card" *ngIf="selectedStatusTab === 'todas'">
    <ion-card-header>
      <ion-card-title style="color: black">
        <ion-icon name="funnel-outline"></ion-icon>
        Filtros Avanzados
      </ion-card-title>
    </ion-card-header>
    <ion-card-content>
      <ion-grid>
        <ion-row>
          <ion-col size="12" size-md="6">
            <ion-item>
              <ion-input
                [(ngModel)]="searchTerm"
                placeholder="Buscar por patente o modelo..."
                (ionInput)="applyFilters()"
                clear-input="true"
              >
                <ion-icon name="search-outline" slot="start"></ion-icon>
              </ion-input>
            </ion-item>
          </ion-col>
          <ion-col size="12" size-md="4">
            <ion-button expand="block" fill="outline" (click)="clearFilters()">
              <ion-icon name="refresh-outline" slot="start"></ion-icon>
              Limpiar Filtros
            </ion-button>
          </ion-col>
        </ion-row>
        <ion-row>
          <ion-col size="12" size-md="6">
            <ion-item>
              <ion-label position="stacked">Desde</ion-label>
              <ion-input
                type="date"
                [(ngModel)]="filterDateFrom"
                (ionChange)="applyDateFilter()"
              ></ion-input>
            </ion-item>
          </ion-col>
          <ion-col size="12" size-md="6">
            <ion-item>
              <ion-label position="stacked">Hasta</ion-label>
              <ion-input
                type="date"
                [(ngModel)]="filterDateTo"
                (ionChange)="applyDateFilter()"
              ></ion-input>
            </ion-item>
          </ion-col>
        </ion-row>
      </ion-grid>
    </ion-card-content>
  </ion-card>

  <!-- Filtro simple de búsqueda para pestañas específicas -->
  <ion-card class="simple-search-card" *ngIf="selectedStatusTab !== 'todas'">
    <ion-card-content>
      <ion-item>
        <ion-input
          [(ngModel)]="searchTerm"
          placeholder="Buscar en {{ getStatusDisplayName(selectedStatusTab) }}..."
          (ionInput)="applyFilters()"
          clear-input="true"
        >
          <ion-icon name="search-outline" slot="start"></ion-icon>
        </ion-input>
      </ion-item>
    </ion-card-content>
  </ion-card>

  <ion-loading [isOpen]="isLoading" message="Cargando..."></ion-loading>

  <!-- Información de resultados -->
  <div *ngIf="!isLoading && totalFilteredItems >= 0" class="results-info">
    <p>
      Mostrando {{ paginatedOrdenes.length }} de {{ totalFilteredItems }}
      órdenes de trabajo
      <span *ngIf="totalFilteredItems !== allItems.length">
        (filtrado de {{ allItems.length }} total)
      </span>
    </p>
  </div>
  <div
    *ngIf="!isLoading && paginatedOrdenes.length === 0 && allItems.length > 0"
    class="ion-text-center ion-padding"
  >
    <ion-icon
      name="search-outline"
      style="font-size: 4em"
      color="medium"
    ></ion-icon>
    <p>No se encontraron órdenes de trabajo con los filtros aplicados.</p>
  </div>
  <div
    *ngIf="!isLoading && allItems.length === 0"
    class="ion-text-center ion-padding"
  >
    <ion-icon
      name="file-tray-outline"
      style="font-size: 4em"
      color="medium"
    ></ion-icon>
    <p>No hay órdenes de trabajo para mostrar.</p>
  </div>

  <ion-list *ngIf="paginatedOrdenes.length > 0">
    <!-- Lista de órdenes ordenadas por número -->
    <ion-item
      *ngFor="let ot of paginatedOrdenes"
      lines="inset"
      class="orden-trabajo-item"
    >
      <ion-grid>
        <ion-row class="ion-align-items-center">
          <ion-col
            size="12"
            size-md="5"
            (click)="verDetalle(ot.id_ot)"
            style="cursor: pointer"
          >
            <ion-label>
              <h2>
                <ion-icon
                  [name]="getIconForStatus(ot.estado_ot)"
                  class="align-middle orden-icon-bold"
                  [color]="getColorForStatus(ot.estado_ot)"
                ></ion-icon>
                OT #{{ ot.id_ot }}
                <span *ngIf="ot.vehiculo">
                  - {{ ot.vehiculo.marca }} {{ ot.vehiculo.modelo }}</span
                >
                <span *ngIf="!ot.vehiculo"> - Vehículo no especificado</span>
              </h2>
              <p>
                <ion-icon
                  name="car-sport-outline"
                  color="primary"
                  class="align-middle"
                ></ion-icon>
                <strong>Patente:</strong>
                <span *ngIf="ot.vehiculo">{{ ot.vehiculo.patente }}</span>
                <span *ngIf="!ot.vehiculo">No especificada</span>
              </p>
              <p>
                <ion-icon
                  name="person-outline"
                  color="success"
                  class="align-middle"
                ></ion-icon>
                <strong>Creador de planificación:</strong> {{
                ot.solicitante?.pri_nom_usu || 'N/A' }} {{
                ot.solicitante?.pri_ape_usu || '' }}
              </p>
            </ion-label>
          </ion-col>

          <ion-col size="12" size-md="2">
            <ion-label class="info-col">
              <p>
                <ion-icon
                  name="calendar-outline"
                  class="align-middle"
                ></ion-icon>
                <strong>Inicio:</strong> {{ ot.fec_ini_ot ? (ot.fec_ini_ot |
                date:'dd/MM/yy') : 'No especificado' }}
              </p>
              <p *ngIf="ot.fec_fin_ot && isValidDate(ot.fec_fin_ot)">
                <ion-icon
                  name="checkmark-done-circle-outline"
                  class="align-middle"
                ></ion-icon>
                <strong>Cierre:</strong> {{ ot.fec_fin_ot | date:'dd/MM/yy' }}
              </p>
            </ion-label>
          </ion-col>
          <ion-col size="12" size-md="2" class="ion-text-center">
            <ion-chip [color]="getColorForStatus(ot.estado_ot)">
              <ion-label>{{ getStatusDisplayName(ot.estado_ot) }}</ion-label>
            </ion-chip>
          </ion-col>

          <ion-col
            size="12"
            size-md="3"
            class="ion-text-md-end ion-text-center action-buttons"
          >
            <ion-button
              fill="clear"
              size="small"
              (click)="verDetalle(ot.id_ot)"
              title="Ver Detalles"
            >
              <ion-icon
                slot="icon-only"
                name="eye-outline"
                color="primary"
              ></ion-icon>
            </ion-button>
          </ion-col>
        </ion-row>
      </ion-grid>
    </ion-item>
  </ion-list>

  <!-- Paginador -->
  <ion-card *ngIf="totalPages > 1" class="pagination-card">
    <ion-card-content>
      <ion-grid>
        <ion-row class="ion-align-items-center">
          <ion-col size="auto">
            <ion-button
              fill="outline"
              [disabled]="currentPage === 1"
              (click)="previousPage()"
            >
              <ion-icon name="chevron-back-outline" slot="icon-only"></ion-icon>
            </ion-button>
          </ion-col>
          <ion-col class="ion-text-center">
            <span> Página {{ currentPage }} de {{ totalPages }} </span>
          </ion-col>
          <ion-col size="auto">
            <ion-button
              fill="outline"
              [disabled]="currentPage === totalPages"
              (click)="nextPage()"
            >
              <ion-icon
                name="chevron-forward-outline"
                slot="icon-only"
              ></ion-icon>
            </ion-button>
          </ion-col>
        </ion-row>
      </ion-grid>
    </ion-card-content>
  </ion-card>
</ion-content>
