<!-- Modal Header -->
<ion-header>
  <ion-toolbar color="primary">
    <ion-title>{{ pageTitle }}</ion-title>
    <ion-buttons slot="end">
      <ion-button (click)="closeModal()" fill="clear" color="light">
        <ion-icon name="close-outline" slot="icon-only"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<!-- Segmentos/Tabs -->
<ion-segment
  [value]="selectedTab"
  (ionChange)="segmentChanged($event)"
  color="primary"
  class="ion-margin-bottom"
>
  <ion-segment-button value="infoBasica">
    <ion-label>Información Básica</ion-label>
  </ion-segment-button>
  <ion-segment-button value="infoAdicional">
    <ion-label>Información Adicional</ion-label>
  </ion-segment-button>
  <ion-segment-button value="documentos" *ngIf="isEditMode || isViewMode">
    <ion-label>Documentos</ion-label>
  </ion-segment-button>
</ion-segment>

<!-- Modal Content -->
<ion-content class="ion-padding ultra-compact">
  <form [formGroup]="vehicleForm" (ngSubmit)="saveVehicle()">
    <!-- Tab: Información Básica -->
    <div *ngIf="selectedTab === 'infoBasica'">
      <!-- Patente y Chasis -->
      <ion-row>
        <ion-col size="12" size-md="6">
          <div class="input-wrapper">
            <ion-label>Patente <ion-text color="danger">*</ion-text></ion-label>
            <ion-input
              formControlName="patente"
              type="text"
              maxlength="6"
              required
              placeholder="XXXXXX (Ej: ABCD12)"
              [readonly]="isViewMode"
            >
            </ion-input>
            <div class="error-container">
              <div
                class="error-message"
                [class.visible]="f['patente'].invalid && (f['patente'].dirty || f['patente'].touched || isSubmitted)"
              >
                <div *ngIf="f['patente'].errors?.['required']">
                  Patente es requerida.
                </div>
                <div *ngIf="f['patente'].errors?.['pattern']">
                  Formato debe ser ABXX12, con los últimos dos caracteres
                  numéricos, y los primeros dos, letras.
                </div>
              </div>
            </div>
          </div>
        </ion-col>
        <ion-col size="12" size-md="6">
          <div class="input-wrapper">
            <ion-label>Chasis <ion-text color="danger">*</ion-text></ion-label>
            <ion-input
              formControlName="chasis"
              type="text"
              required
              placeholder="El número debe tener 17 caracteres"
              maxlength="17"
              autocapitalize="characters"
              [readonly]="isViewMode"
            >
            </ion-input>
            <div class="error-container">
              <div
                class="error-message"
                [class.visible]="f['chasis'].invalid && (f['chasis'].dirty || f['chasis'].touched || isSubmitted)"
              >
                <div *ngIf="f['chasis'].errors?.['required']">
                  Chasis es requerido.
                </div>
                <div
                  *ngIf="f['chasis'].errors?.['minlength'] || f['chasis'].errors?.['maxlength']"
                >
                  Chasis debe tener 17 caracteres.
                </div>
                <div *ngIf="f['chasis'].errors?.['pattern']">
                  Chasis solo debe contener letras y números.
                </div>
              </div>
            </div>
          </div>
        </ion-col>
      </ion-row>

      <!-- Marca y Modelo -->
      <ion-row>
        <ion-col size="12" size-md="6">
          <div class="input-wrapper">
            <ion-label>Marca <ion-text color="danger">*</ion-text></ion-label>
            <ion-input
              formControlName="marca"
              placeholder="Ej: Toyota"
              type="text"
              required
              [readonly]="isViewMode"
            >
            </ion-input>
            <div class="error-container">
              <div
                class="error-message"
                [class.visible]="f['marca'].invalid && (f['marca'].dirty || f['marca'].touched || isSubmitted)"
              >
                <div *ngIf="f['marca'].errors?.['required']">
                  Marca es requerida.
                </div>
              </div>
            </div>
          </div>
        </ion-col>
        <ion-col size="12" size-md="6">
          <div class="input-wrapper">
            <ion-label>Modelo <ion-text color="danger">*</ion-text></ion-label>
            <ion-input
              formControlName="modelo"
              placeholder="Ej: Hilux"
              type="text"
              required
              [readonly]="isViewMode"
            >
            </ion-input>
            <div class="error-container">
              <div
                class="error-message"
                [class.visible]="f['modelo'].invalid && (f['modelo'].dirty || f['modelo'].touched || isSubmitted)"
              >
                <div *ngIf="f['modelo'].errors?.['required']">
                  Modelo es requerido.
                </div>
              </div>
            </div>
          </div>
        </ion-col>
      </ion-row>

      <!-- Año y Kilometraje -->
      <ion-row>
        <ion-col size="12" size-md="6">
          <div class="input-wrapper">
            <ion-label>Año <ion-text color="danger">*</ion-text></ion-label>
            <ion-input
              formControlName="anio"
              type="number"
              inputmode="numeric"
              min="1970"
              max="2025"
              required
              placeholder="Entre 1970 y 2025"
              [readonly]="isViewMode"
            >
            </ion-input>
            <div class="error-container">
              <div
                class="error-message"
                [class.visible]="f['anio'].invalid && (f['anio'].dirty || f['anio'].touched || isSubmitted)"
              >
                <div *ngIf="f['anio'].errors?.['required']">
                  Año es requerido.
                </div>
                <div
                  *ngIf="f['anio'].errors?.['min'] || f['anio'].errors?.['max']"
                >
                  Año debe estar entre 1970 y 2025.
                </div>
              </div>
            </div>
          </div>
        </ion-col>
        <ion-col size="12" size-md="6">
          <div class="input-wrapper">
            <ion-label
              >Kilometraje <ion-text color="danger">*</ion-text></ion-label
            >
            <ion-input
              formControlName="kmVehi"
              type="number"
              inputmode="numeric"
              min="0"
              max="1000000"
              required
              placeholder="Máximo 1.000.000 km"
              [readonly]="isViewMode"
            >
            </ion-input>
            <div class="error-container">
              <div
                class="error-message"
                [class.visible]="f['kmVehi'].invalid && (f['kmVehi'].dirty || f['kmVehi'].touched || isSubmitted)"
              >
                <div *ngIf="f['kmVehi'].errors?.['required']">
                  Kilometraje es requerido.
                </div>
                <div *ngIf="f['kmVehi'].errors?.['min']">
                  Kilometraje debe ser positivo.
                </div>
                <div *ngIf="f['kmVehi'].errors?.['max']">
                  Kilometraje no puede superar 1.000.000 km.
                </div>
              </div>
            </div>
          </div>
        </ion-col>
      </ion-row>

      <!-- Fecha de Adquisición y Estado -->
      <ion-row>
        <ion-col size="12" size-md="6">
          <div class="input-wrapper">
            <ion-label
              >Fecha de Adquisición
              <ion-text color="danger">*</ion-text></ion-label
            >
            <ion-input
              formControlName="fecAdqui"
              type="date"
              required
              displayFormat="YYYY-MM-DD"
              pickerFormat="YYYY-MM-DD"
              placeholder="Fecha de adquisición"
              [readonly]="isViewMode"
            >
            </ion-input>
            <div class="error-container">
              <div
                class="error-message"
                [class.visible]="f['fecAdqui'].invalid && (f['fecAdqui'].dirty || f['fecAdqui'].touched || isSubmitted)"
              >
                <div *ngIf="f['fecAdqui'].errors?.['required']">
                  Fecha de adquisición es requerida.
                </div>
              </div>
            </div>
          </div>
        </ion-col>
        <ion-col size="12" size-md="6">
          <div class="input-wrapper">
            <ion-label>Estado <ion-text color="danger">*</ion-text></ion-label>
            <ion-select
              formControlName="estadoVehi"
              interface="popover"
              placeholder="Selecciona estado"
              [disabled]="isViewMode"
            >
              <ion-select-option
                *ngFor="let estado of estadosVehiculoOptions"
                [value]="estado"
              >
                {{ estado | titlecase }}
              </ion-select-option>
            </ion-select>
            <div class="error-container">
              <div
                class="error-message"
                [class.visible]="f['estadoVehi'].invalid && (f['estadoVehi'].dirty || f['estadoVehi'].touched || isSubmitted)"
              >
                <div *ngIf="f['estadoVehi'].errors?.['required']">
                  Estado es requerido.
                </div>
              </div>
            </div>
          </div>
        </ion-col>
      </ion-row>
    </div>

    <!-- Tab: Información Adicional -->
    <div *ngIf="selectedTab === 'infoAdicional'">
      <!-- Tipo de Vehículo y Tipo de Combustible -->
      <ion-row>
        <ion-col size="12" size-md="6">
          <div class="input-wrapper">
            <ion-label>Tipo de Vehículo</ion-label>
            <ion-select
              formControlName="tipoVehi"
              interface="popover"
              placeholder="Selecciona tipo de vehículo"
              [disabled]="isViewMode"
            >
              <ion-select-option value="Camioneta">Camioneta</ion-select-option>
              <ion-select-option value="Furgón">Furgón</ion-select-option>
              <ion-select-option value="Camión Liviano"
                >Camión Liviano</ion-select-option
              >
              <ion-select-option value="Camión Pesado"
                >Camión Pesado</ion-select-option
              >
            </ion-select>
            <div class="error-container">
              <div class="error-message"></div>
            </div>
          </div>
        </ion-col>
        <ion-col size="12" size-md="6">
          <div class="input-wrapper">
            <ion-label>Tipo de Combustible</ion-label>
            <ion-select
              formControlName="tipoCombVehi"
              interface="popover"
              placeholder="Seleccione el tipo de combustible"
              [disabled]="isViewMode"
            >
              <ion-select-option value="">Ninguno</ion-select-option>
              <ion-select-option value="gasolina_93"
                >93 Octanos</ion-select-option
              >
              <ion-select-option value="gasolina_95"
                >95 Octanos</ion-select-option
              >
              <ion-select-option value="gasolina_97"
                >97 Octanos</ion-select-option
              >
              <ion-select-option value="diesel">Diesel</ion-select-option>
              <ion-select-option value="electrico">Eléctrico</ion-select-option>
            </ion-select>
            <div class="error-container">
              <div class="error-message"></div>
            </div>
          </div>
        </ion-col>
      </ion-row>

      <!-- Kilometraje Vida Útil y Eficiencia Combustible -->
      <ion-row>
        <ion-col size="12" size-md="6">
          <div class="input-wrapper">
            <ion-label>Kilometraje Vida Útil</ion-label>
            <ion-input
              formControlName="kmVidaUtil"
              type="number"
              inputmode="numeric"
              min="1000"
              max="5000000"
              placeholder="Entre 1.000 y 5.000.000 km"
              [readonly]="isViewMode"
            >
            </ion-input>
            <div class="error-container">
              <div
                class="error-message"
                [class.visible]="f['kmVidaUtil'].invalid && (f['kmVidaUtil'].dirty || f['kmVidaUtil'].touched || isSubmitted)"
              >
                <div *ngIf="f['kmVidaUtil'].errors?.['min']">
                  Kilometraje vida útil debe ser al menos 1.000 km.
                </div>
                <div *ngIf="f['kmVidaUtil'].errors?.['max']">
                  Kilometraje vida útil no puede superar 5.000.000 km.
                </div>
              </div>
            </div>
          </div>
        </ion-col>
        <ion-col size="12" size-md="6">
          <div class="input-wrapper">
            <ion-label>Eficiencia Combustible (km/L)</ion-label>
            <ion-input
              formControlName="efiComb"
              type="number"
              inputmode="decimal"
              step="0.01"
              min="2"
              max="30"
              placeholder="Entre 2 y 30 km/L"
              [readonly]="isViewMode"
            >
            </ion-input>
            <div class="error-container">
              <div
                class="error-message"
                [class.visible]="f['efiComb'].invalid && (f['efiComb'].dirty || f['efiComb'].touched || isSubmitted)"
              >
                <div *ngIf="f['efiComb'].errors?.['min']">
                  Eficiencia debe ser al menos 2 km/L.
                </div>
                <div *ngIf="f['efiComb'].errors?.['max']">
                  Eficiencia no puede superar 30 km/L.
                </div>
              </div>
            </div>
          </div>
        </ion-col>
      </ion-row>

    </div>
  </form>


  <!-- TAB: RECORRIDOS -->
  <div *ngIf="selectedTab === 'recorridos'" class="ion-margin-top">
    <ion-card>
      <ion-card-header>
        <ion-card-title>Historial de Recorridos</ion-card-title>
        <ion-card-subtitle
          >Recorridos realizados por este vehículo</ion-card-subtitle
        >
      </ion-card-header>
      <ion-card-content>
        <app-data-table
          [columns]="recorridosColumns"
          [data]="recorridos"
          [pageSize]="10"
          [totalItems]="recorridos.length"
          [showPagination]="true"
          [showExport]="true"
          [showImport]="false"
          (page)="onRecorridosPageChange($event)"
          (rowClick)="onRecorridosRowClick($event)"
          (sort)="onRecorridosSort($event)"
          (export)="onRecorridosExport($event)"
        >
        </app-data-table>
      </ion-card-content>
    </ion-card>
  </div>

  <!-- TAB: COMBUSTIBLE -->
  <div *ngIf="selectedTab === 'combustible'" class="ion-margin-top">
    <ion-card>
      <ion-card-header>
        <ion-card-title>Registro de Combustible</ion-card-title>
        <ion-card-subtitle
          >Historial de cargas de combustible</ion-card-subtitle
        >
      </ion-card-header>
      <ion-card-content>
        <app-data-table
          [columns]="combustibleColumns"
          [data]="combustible"
          [pageSize]="10"
          [totalItems]="combustible.length"
          [showPagination]="true"
          [showExport]="true"
          [showImport]="false"
          (page)="onCombustiblePageChange($event)"
          (rowClick)="onCombustibleRowClick($event)"
          (sort)="onCombustibleSort($event)"
          (export)="onCombustibleExport($event)"
        >
        </app-data-table>
      </ion-card-content>
    </ion-card>
  </div>

  <!-- TAB: MANTENIMIENTO -->
  <div *ngIf="selectedTab === 'mantenimiento'" class="ion-margin-top">
    <ion-card>
      <ion-card-header>
        <ion-card-title>Historial de Mantenimientos</ion-card-title>
        <ion-card-subtitle
          >Registros de mantenimientos realizados</ion-card-subtitle
        >
      </ion-card-header>
      <ion-card-content>
        <app-data-table
          [columns]="mantenimientoColumns"
          [data]="mantenimientoCompleto"
          [pageSize]="10"
          [totalItems]="mantenimientoCompleto.length"
          [showPagination]="true"
          [showExport]="true"
          [showImport]="false"
          (page)="onMantenimientoPageChange($event)"
          (rowClick)="onMantenimientoRowClick($event)"
          (sort)="onMantenimientoSort($event)"
          (export)="onMantenimientoExport($event)"
        >
        </app-data-table>
      </ion-card-content>
    </ion-card>
  </div>

  <!-- TAB: INCIDENTES -->
  <div *ngIf="selectedTab === 'incidentes'" class="ion-margin-top">
    <ion-card>
      <ion-card-header>
        <ion-card-title>Registro de Incidentes</ion-card-title>
        <ion-card-subtitle
          >Incidentes y siniestros reportados</ion-card-subtitle
        >
      </ion-card-header>
      <ion-card-content>
        <app-data-table
          [columns]="incidentesColumns"
          [data]="incidentes"
          [pageSize]="10"
          [totalItems]="incidentes.length"
          [showPagination]="true"
          [showExport]="true"
          [showImport]="false"
          (page)="onIncidentesPageChange($event)"
          (rowClick)="onIncidentesRowClick($event)"
          (sort)="onIncidentesSort($event)"
          (export)="onIncidentesExport($event)"
        >
        </app-data-table>
      </ion-card-content>
    </ion-card>
  </div>

  <!-- TAB: DOCUMENTOS -->
  <div *ngIf="selectedTab === 'documentos'" class="ion-margin-top">
    <ion-card>
      <ion-card-header>
        <ion-card-title>Documentación del Vehículo</ion-card-title>
        <ion-card-subtitle>Documentos y registros asociados</ion-card-subtitle>
      </ion-card-header>
      <ion-card-content>
        <ion-list lines="full">
          <ion-item *ngIf="documentos.length === 0">
            <ion-label color="medium">
              <p class="ion-text-center">
                No hay documentos registrados para este vehículo.
              </p>
            </ion-label>
          </ion-item>
          <ion-item *ngFor="let doc of documentos">
            <ion-icon
              name="document-outline"
              slot="start"
              color="primary"
            ></ion-icon>
            <ion-label>
              <h2>{{ doc.nombre }}</h2>
              <p>{{ doc.descripcion }}</p>
              <p>Fecha: {{ doc.fecha | date:'dd/MM/yyyy' }}</p>
            </ion-label>
            <ion-buttons slot="end">
              <ion-button fill="clear" color="primary">
                <ion-icon name="eye-outline" slot="icon-only"></ion-icon>
              </ion-button>
              <ion-button fill="clear" color="primary">
                <ion-icon name="download-outline" slot="icon-only"></ion-icon>
              </ion-button>
            </ion-buttons>
          </ion-item>
        </ion-list>
        <ion-button
          expand="block"
          color="tertiary"
          class="ion-margin-top"
          *ngIf="!isViewMode"
        >
          <ion-icon name="add-circle-outline" slot="start"></ion-icon>
          Subir Nuevo Documento
        </ion-button>
      </ion-card-content>
    </ion-card>
  </div>
</ion-content>

<!-- Footer con botones de acción -->
<div class="ion-text-center" *ngIf="!isViewMode">
  <ion-button
    type="submit"
    expand="block"
    (click)="saveVehicle()"
    style="--background: #008000; --background-hover: #006600"
  >
    <ion-icon
      [name]="isEditMode ? 'save-outline' : 'add-circle-outline'"
      slot="start"
    ></ion-icon>
    {{ isEditMode ? 'Actualizar Vehículo' : 'Crear Vehículo' }}
  </ion-button>
</div>

<div class="ion-text-center" *ngIf="isViewMode">
  <ion-button expand="block" (click)="closeModal()" color="medium">
    <ion-icon name="close-outline" slot="start"></ion-icon>
    Cerrar
  </ion-button>
</div>
